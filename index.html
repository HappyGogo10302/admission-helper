<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>接Pa小幫手 (優化版 V3.8)</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 Google Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* 設定字體為 Inter */
        html { font-family: 'Inter', sans-serif; }
        /* 隱藏預設的數字輸入箭頭 */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        /* 確保預測列表正確浮動在輸入框下方 */
        .autocomplete-list {
            position: absolute;
            z-index: 10;
            width: 100%;
            margin-top: 1px;
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            max-height: 10rem;
            overflow-y: auto;
        }
        .autocomplete-item:hover {
            background-color: #f3f4f6;
        }
    </style>
    <script>
        // 設定 Tailwind CSS 的主題
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#10b981', /* Emerald 500 */
                        'secondary': '#60a5fa', /* Blue 400 */
                        'danger': '#f43f5e', /* Rose 500 */
                        'bg-light': '#f9fafb',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-bg-light min-h-screen p-4 sm:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-gray-900 mb-2">接PA小幫手 (優化版 V3.8)</h1>
            <p class="text-gray-500">新增主訴性質選項，並優化使用者提示。</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- 輸入表單區 -->
            <div class="bg-white p-6 rounded-xl shadow-lg h-full">
                <h2 class="text-xl font-semibold text-gray-800 mb-6 border-b pb-2">病歷資訊輸入</h2>
                
                <form id="note-form" class="space-y-6">
                    
                    <!-- 1. Demographics & UD -->
                    <div>
                        <h3 class="font-medium text-primary mb-2">1. 基本資料與病史 (Demographics & History)</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <label class="block">
                                <span class="text-gray-700 text-sm">年齡 (Age)</span>
                                <input type="number" id="age" placeholder="e.g. 59" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-2" required>
                            </label>
                            <label class="block">
                                <span class="text-gray-700 text-sm">性別 (Gender)</span>
                                <select id="gender" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-2" required>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                </select>
                            </label>
                             <label class="block col-span-2">
                                <span class="text-gray-700 text-sm">日常生活活動能力 (ADL Status)</span>
                                <select id="adl-status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-2">
                                    <option value="independent" selected>Independent</option>
                                    <option value="partially dependent">Partially Dependent</option>
                                    <option value="totally dependent">Totally Dependent</option>
                                </select>
                            </label>
                        </div>

                        <!-- OB/GYN History Section -->
                        <div id="obgyn-section" class="hidden mt-4 p-4 bg-purple-50 rounded-lg border border-purple-200">
                            <h4 class="font-medium text-purple-700 mb-3 text-sm">婦產科病史 (Obstetric History)</h4>
                            <div class="grid grid-cols-3 gap-4">
                                <label class="block">
                                    <span class="text-gray-700 text-sm">胎次 (G)</span>
                                    <input type="number" id="gravida" placeholder="e.g. 2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                                </label>
                                <label class="block">
                                    <span class="text-gray-700 text-sm">產次 (P)</span>
                                    <input type="number" id="para" placeholder="e.g. 2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                                </label>
                                <label class="block">
                                    <span class="text-gray-700 text-sm">末次月經 (LMP)</span>
                                    <input type="date" id="lmp" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                                </label>
                            </div>
                        </div>
                        
                        <!-- UD SEARCH SECTION -->
                        <div class="mt-4 relative">
                            <span class="text-gray-700 text-sm font-medium block mb-2">潛在疾病搜索 (Underlying Diseases)</span>
                            <input type="text" id="ud-search-input" placeholder="輸入疾病名稱或簡寫 (e.g. DM, HTN)" 
                                   class="w-full rounded-md border-gray-300 shadow-sm p-2 text-sm">
                            <div id="ud-suggestions" class="autocomplete-list hidden"></div>
                            <div id="selected-ud-tags" class="mt-3 flex flex-wrap gap-2 min-h-[20px]"></div>
                        </div>
                    </div>

                    <!-- 2. HPI -->
                    <div>
                        <h3 class="font-medium text-primary mb-2">2. 現在病史 (HPI)</h3>

                        <div class="relative mb-4">
                            <span class="text-gray-700 text-sm font-medium block mb-2">主訴 (Chief Complaint, CC)</span>
                            <input type="text" id="cc-search-input" placeholder="輸入主訴症狀或簡寫 (e.g. Jaundice)" 
                                   class="w-full rounded-md border-gray-300 shadow-sm p-2 text-sm">
                            <div id="cc-suggestions" class="autocomplete-list hidden"></div>
                            <div id="selected-cc-tag" class="mt-3 flex flex-wrap gap-2 min-h-[20px]"></div>
                        </div>

                        <div class="grid grid-cols-6 gap-4 mt-4 items-end">
                            <label class="block col-span-6 sm:col-span-3">
                                <span class="text-gray-700 text-sm">主訴性質 (CC Character)</span>
                                <select id="cc-character" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                                    <option value="progressive" selected>Progressive (漸進性)</option>
                                    <option value="sudden onset">Sudden Onset (突發性)</option>
                                    <option value="intermittent">Intermittent (間歇性)</option>
                                    <option value="recurrent">Recurrent (反覆性)</option>
                                </select>
                            </label>
                            <label class="block col-span-4 sm:col-span-2">
                                <span class="text-gray-700 text-sm">持續時間 (Duration)</span>
                                <input type="number" id="cc-duration-value" placeholder="e.g. 3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                            </label>
                            <label class="block col-span-2 sm:col-span-1">
                                <span class="text-gray-700 text-sm opacity-0 select-none">Unit</span>
                                <select id="cc-duration-unit" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                                    <option value="day(s)">day(s)</option>
                                    <option value="week(s)">week(s)</option>
                                    <option value="month(s)">month(s)</option>
                                </select>
                            </label>
                        </div>
                        
                        <div class="mt-4">
                            <label class="block">
                                <span class="text-gray-700 text-sm">HPI 詳細描述 (HPI Narrative)</span>
                                <textarea id="hpi-narrative" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" placeholder="e.g. progressive yellowish skin discoloration"></textarea>
                                <p class="text-xs text-gray-500 mt-1">註：此欄位若留白，將依主訴性質自動生成描述；若填寫，則會完全取代自動描述。</p>
                            </label>
                        </div>
                        
                        <div class="mt-4 p-4 bg-indigo-50 rounded-lg relative">
                            <span class="text-gray-700 text-sm font-medium block mb-2">伴隨症狀 (Associated Symptoms)</span>
                            <input type="text" id="symptom-search-input" placeholder="輸入伴隨症狀 (e.g. tea color urine)" 
                                   class="w-full rounded-md border-gray-300 shadow-sm p-2 text-sm">
                            <div id="symptom-suggestions" class="autocomplete-list hidden"></div>
                            <div id="selected-symptoms-tags" class="mt-3 flex flex-wrap gap-2 min-h-[20px]"></div>
                        </div>

                        <div class="mt-4 p-3 bg-red-50 rounded-lg">
                            <span class="text-gray-700 text-sm font-medium block mb-2">否認症狀 (Denied Symptoms)</span>
                            <div id="denied-symptoms-container" class="grid grid-cols-2 gap-y-2 text-sm"></div>
                        </div>
                    </div>

                    <!-- 3. ER/OPD Course -->
                    <div>
                        <h3 class="font-medium text-primary mb-2">3. 就診過程 (ER/OPD Course)</h3>
                        <div class="flex items-center mb-4">
                           <input type="checkbox" id="visited-opd" class="form-checkbox text-primary rounded">
                           <label for="visited-opd" class="ml-2 text-gray-700 text-sm">曾先至門診就診 (Visited OPD before ER)</label>
                        </div>

                        <div id="opd-course-section" class="hidden space-y-4">
                             <label class="block">
                                <span class="text-gray-700 text-sm">門診異常報告日期 (OPD Lab Date)</span>
                                <input type="date" id="lab-date" class="mt-1 w-full rounded-md border-gray-300 shadow-sm p-2">
                            </label>
                             <label class="block">
                                <span class="text-gray-700 text-sm">轉診原因 (Referral Reason)</span>
                                <input type="text" id="referral-reason" placeholder="e.g. further management" class="mt-1 w-full rounded-md border-gray-300 shadow-sm p-2">
                            </label>
                        </div>

                        <h4 class="font-medium text-gray-800 my-4">急診發現 (ER Findings)</h4>
                        
                        <div class="p-4 border rounded-lg bg-gray-50 space-y-4">
                            <div>
                                <span class="text-sm font-semibold text-gray-600 block mb-2">生命徵象 (Vital Signs)</span>
                                <div class="grid grid-cols-3 md:grid-cols-6 gap-2 text-sm">
                                    <input type="text" id="vs-t" placeholder="T (°C)" value="" class="p-1.5 rounded-md border-gray-300">
                                    <input type="text" id="vs-p" placeholder="P (/min)" value="" class="p-1.5 rounded-md border-gray-300">
                                    <input type="text" id="vs-r" placeholder="R (/min)" value="" class="p-1.5 rounded-md border-gray-300">
                                    <input type="text" id="vs-bp" placeholder="BP (mmHg)" value="" class="p-1.5 rounded-md border-gray-300">
                                    <input type="text" id="vs-spo2" placeholder="SpO2 (%)" value="" class="p-1.5 rounded-md border-gray-300">
                                    <select id="mental-status" class="p-1.5 rounded-md border-gray-300">
                                        <option value="clear">Clear</option>
                                        <option value="confused">Confused</option>
                                        <option value="drowsy">Drowsy</option>
                                    </select>
                                </div>
                                <div class="grid grid-cols-3 gap-2 mt-2 text-sm">
                                    <input type="number" id="gcs-e" placeholder="E" value="4" class="p-1.5 rounded-md border-gray-300">
                                    <input type="number" id="gcs-v" placeholder="V" value="5" class="p-1.5 rounded-md border-gray-300">
                                    <input type="number" id="gcs-m" placeholder="M" value="6" class="p-1.5 rounded-md border-gray-300">
                                </div>
                            </div>

                            <label class="block">
                                <span class="text-gray-700 text-sm">理學檢查 (Physical Exam)</span>
                                <textarea id="pe-findings" rows="3" class="mt-1 w-full rounded-md border-gray-300 shadow-sm p-2" placeholder="e.g. Sclera icteric, abdomen soft and non-tender, no hepatosplenomegaly."></textarea>
                            </label>

                            <label class="block">
                                <span class="text-gray-700 text-sm">急診處置與檢查 (ER Management & Survey)</span>
                                <textarea id="er-management" rows="3" class="mt-1 w-full rounded-md border-gray-300 shadow-sm p-2" placeholder="e.g. IV fluid hydration was given, and abdominal CT was arranged."></textarea>
                            </label>
                            
                            <div class="mb-4 text-sm">
                                <label class="block">
                                    <span class="text-gray-700 text-sm font-medium">貼上原始報告 (Raw Lab Text)</span>
                                    <textarea id="lab-raw-input" rows="10" placeholder="請貼上血液及生化報告，系統將自動提取異常數值。&#10;e.g.&#10;WBC 1000/uL 7.5&#10;Total Bilirubin mg/dL 15.2&#10;CRP mg/L 9.17" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 font-mono text-xs"></textarea>
                                </label>
                                <div id="lab-summary-output" class="mt-4 p-2 bg-white rounded border border-dashed border-gray-300 min-h-[50px]">
                                    <span class="text-gray-500 text-xs">自動提取的關鍵結果將顯示在這裡...</span>
                                </div>
                            </div>

                             <div class="grid grid-cols-2 gap-4">
                                <label class="block">
                                    <span class="text-gray-700 text-sm">尿液培養 (Urine Culture)</span>
                                    <input type="text" id="urine-culture" class="mt-1 w-full rounded-md border-gray-300 shadow-sm p-2" placeholder="N/A">
                                </label>
                                <label class="block">
                                    <span class="text-gray-700 text-sm">糞便培養 (Stool Culture)</span>
                                    <input type="text" id="stool-culture" class="mt-1 w-full rounded-md border-gray-300 shadow-sm p-2" placeholder="N/A">
                                </label>
                            </div>

                            <label class="block">
                                <span class="text-gray-700 text-sm">影像學發現 (Imaging Findings)</span>
                                <textarea id="imaging-findings" rows="3" class="mt-1 w-full rounded-md border-gray-300 shadow-sm p-2"></textarea>
                            </label>
                        </div>
                    </div>

                    <!-- 4. Impression & Plan -->
                    <div>
                        <h3 class="font-medium text-primary mb-2">4. 診斷與計畫 (Impression & Plan)</h3>
                        
                        <div class="relative mb-4">
                            <span class="text-gray-700 text-sm font-medium block mb-2">主要診斷 (Impression)</span>
                            <input type="text" id="imp-search-input" placeholder="輸入診斷名稱或簡寫 (e.g. Klatskin)" 
                                   class="w-full rounded-md border-gray-300 shadow-sm p-2 text-sm">
                            <div id="imp-suggestions" class="autocomplete-list hidden"></div>
                            <div id="selected-imp-tag" class="mt-3 flex flex-wrap gap-2 min-h-[20px]"></div>
                        </div>

                        <label class="block mt-4">
                            <span class="text-gray-700 text-sm">住院計畫 (Plan)</span>
                            <input type="text" id="admission-purpose" placeholder="e.g. further evaluation and management" class="mt-1 w-full rounded-md border-gray-300 shadow-sm p-2" required>
                        </label>
                    </div>

                </form>
            </div>

            <!-- 輸出區 -->
            <div class="bg-white p-6 rounded-xl shadow-lg flex flex-col">
                <h2 class="text-xl font-semibold text-gray-800 mb-6 border-b pb-2">病歷輸出結果</h2>
                
                <textarea id="output-note" readonly rows="20" class="flex-grow w-full border-2 border-gray-200 rounded-lg p-4 font-mono text-sm resize-none bg-gray-50 mb-4 focus:outline-none"></textarea>

                <div class="flex items-center gap-4">
                    <button id="copy-button" class="flex-grow bg-secondary hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                        複製病歷文字 (Copy Note)
                    </button>
                    <button id="clear-form-button" class="bg-danger hover:bg-rose-600 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                        清除表單 (Clear Form)
                    </button>
                </div>
                <div id="copy-message" class="text-sm text-center text-primary mt-2 hidden">已成功複製!</div>
            </div>

        </div>
    </div>

    <script>
        // Data and State Management
        const icd10Data = [
            // CV/Pulm
            { type: 'UD', code: 'I10', english: 'Hypertension', chinese: '高血壓', abbr: 'HTN' },
            { type: 'UD', code: 'E11.9', english: 'Diabetes Mellitus, Unspecified', chinese: '糖尿病', abbr: 'DM' },
            { type: 'UD', code: 'I50.9', english: 'Congestive Heart Failure', chinese: '鬱血性心衰竭', abbr: 'CHF' },
            { type: 'UD', code: 'I21.9', english: 'Acute myocardial infarction', chinese: '急性心肌梗塞', abbr: 'AMI' },
            { type: 'UD', code: 'I25.10', english: 'Atherosclerotic heart disease', chinese: '冠狀動脈疾病', abbr: 'CAD' },
            { type: 'UD', code: 'I48.9', english: 'Atrial fibrillation', chinese: '心房顫動', abbr: 'Af' },
            { type: 'UD', code: 'I26.90', english: 'Pulmonary Embolism', chinese: '肺栓塞', abbr: 'PE' },
            { type: 'UD', code: 'I71.0', english: 'Aortic Dissection', chinese: '主動脈剝離', abbr: 'AD' },
            { type: 'UD', code: 'I70.2', english: 'Peripheral Artery Disease', chinese: '週邊動脈疾病', abbr: 'PAD' },
            { type: 'UD', code: 'I82.90', english: 'Deep Vein Thrombosis', chinese: '深層靜脈栓塞', abbr: 'DVT' },
            { type: 'UD', code: 'J44.9', english: 'Chronic obstructive pulmonary disease', chinese: '慢性阻塞性肺病', abbr: 'COPD' },
            { type: 'UD', code: 'J45.909', english: 'Asthma', chinese: '氣喘', abbr: 'Asthma' },
            { type: 'UD', code: 'J18.9', english: 'Pneumonia', chinese: '肺炎', abbr: 'PNA' },
            // GI/Liver/Renal/Endo
            { type: 'UD', code: 'K74.6', english: 'Other and unspecified cirrhosis of liver', chinese: '肝硬化', abbr: 'LC' },
            { type: 'UD', code: 'C24.0', english: 'Klatskin tumor', chinese: 'Klatskin腫瘤', abbr: 'Klatskin' },
            { type: 'UD', code: 'K85.90', english: 'Acute Pancreatitis', chinese: '急性胰臟炎', abbr: 'AP' },
            { type: 'UD', code: 'K81.9', english: 'Cholecystitis, unspecified', chinese: '膽囊炎', abbr: 'Cholecystitis' },
            { type: 'UD', code: 'K57.90', english: 'Diverticulitis', chinese: '憩室炎', abbr: 'Diverticulitis' },
            { type: 'UD', code: 'K56.60', english: 'Intestinal Obstruction', chinese: '腸阻塞', abbr: 'BO' },
            { type: 'UD', code: 'K46.9', english: 'Abdominal hernia', chinese: '腹部疝氣', abbr: 'Hernia' },
            { type: 'UD', code: 'K27.9', english: 'Peptic Ulcer Disease', chinese: '消化性潰瘍', abbr: 'PUD' },
            { type: 'UD', code: 'N17.9', english: 'Acute Kidney Injury', chinese: '急性腎損傷', abbr: 'AKI' },
            { type: 'UD', code: 'N18.6', english: 'End-Stage Renal Disease', chinese: '末期腎病', abbr: 'ESRD' },
            { type: 'UD', code: 'N18.9', english: 'Chronic kidney disease, unspecified', chinese: '慢性腎臟病', abbr: 'CKD' },
            { type: 'UD', code: 'E87.2', english: 'Acidosis, unspecified', chinese: '酸中毒', abbr: 'Acidosis' },
            { type: 'UD', code: 'E03.9', english: 'Hypothyroidism', chinese: '甲狀腺功能低下', abbr: 'HypoThy' },
            // Neuro/Infectious/General
            { type: 'UD', code: 'I63.9', english: 'Cerebral Infarction (Stroke)', chinese: '腦中風', abbr: 'CVA' },
            { type: 'UD', code: 'I69.3', english: 'Sequelae of cerebral infarction', chinese: '腦梗塞後遺症', abbr: 'p/o CVA' },
            { type: 'UD', code: 'R41.82', english: 'Altered mental status', chinese: '急性意識改變', abbr: 'A-LOC' },
            { type: 'UD', code: 'G45.9', english: 'Transient ischemic attack', chinese: '暫時性腦缺血', abbr: 'TIA' },
            { type: 'UD', code: 'G40.909', english: 'Epilepsy, unspecified', chinese: '癲癇', abbr: 'Epilepsy' },
            { type: 'UD', code: 'A41.9', english: 'Sepsis, unspecified', chinese: '敗血症', abbr: 'Sepsis' },
            { type: 'UD', code: 'R65.20', english: 'Septic Shock', chinese: '敗血性休克', abbr: 'Septic Shock' },
            { type: 'UD', code: 'N39.0', english: 'Urinary Tract Infection', chinese: '泌尿道感染', abbr: 'UTI' },
            { type: 'UD', code: 'A09', english: 'Infectious Gastroenteritis', chinese: '感染性腸胃炎', abbr: 'GE' },
            { type: 'UD', code: 'L03.90', english: 'Cellulitis', chinese: '蜂窩組織炎', abbr: 'Cellulitis' },
            { type: 'UD', code: 'L89.90', english: 'Pressure Ulcer', chinese: '壓力性潰瘍', abbr: 'Decubitus' },
            { type: 'UD', code: 'M54.5', english: 'Low back pain', chinese: '下背痛', abbr: 'LBP' },
            { type: 'UD', code: 'F41.1', english: 'Generalized anxiety disorder', chinese: '廣泛性焦慮症', abbr: 'GAD' },
            { type: 'UD', code: 'C34.90', english: 'Malignant neoplasm of lung', chinese: '肺癌', abbr: 'Lung CA' },
            { type: 'UD', code: 'C18.9', english: 'Malignant neoplasm of colon', chinese: '大腸直腸癌', abbr: 'CRC' },
            // OB/GYN
            { type: 'UD', code: 'O99.8', english: 'History of Cesarean Section', chinese: '剖腹產病史', abbr: 'p/o C/S' },
            { type: 'UD', code: 'O14.9', english: 'Preeclampsia', chinese: '子癇前症', abbr: 'Preeclampsia' },
            { type: 'UD', code: 'O36.9', english: 'High-risk pregnancy', chinese: '高危險妊娠', abbr: 'HRP' },
            { type: 'UD', code: 'N80.9', english: 'Endometriosis', chinese: '子宮內膜異位症', abbr: 'Endo' },
            { type: 'UD', code: 'D25.9', english: 'Uterine fibroids', chinese: '子宮肌瘤', abbr: 'Myoma' },
            { type: 'UD', code: 'N83.2', english: 'Ovarian cyst', chinese: '卵巢囊腫', abbr: 'Ovarian Cyst' },
            { type: 'UD', code: 'N73.9', english: 'Pelvic inflammatory disease', chinese: '骨盆腔發炎', abbr: 'PID' },
            { type: 'UD', code: 'C53.9', english: 'Cervical cancer', chinese: '子宮頸癌', abbr: 'Cervical CA' },
            // Rheum/Autoimmune
            { type: 'UD', code: 'M06.9', english: 'Rheumatoid Arthritis', chinese: '類風濕性關節炎', abbr: 'RA' },
            { type: 'UD', code: 'M32.9', english: 'Systemic Lupus Erythematosus', chinese: '全身性紅斑狼瘡', abbr: 'SLE' },
            { type: 'UD', code: 'M35.0', english: 'Sjögren\'s Syndrome', chinese: '乾燥症', abbr: 'SS' },
            { type: 'UD', code: 'M45.9', english: 'Ankylosing Spondylitis', chinese: '僵直性脊椎炎', abbr: 'AS' },
            { type: 'UD', code: 'L40.9', english: 'Psoriasis', chinese: '乾癬', abbr: 'Psoriasis' },
            { type: 'UD', code: 'K51.9', english: 'Inflammatory Bowel Disease', chinese: '發炎性腸道疾病', abbr: 'IBD' },
            { type: 'UD', code: 'G70.0', english: 'Myasthenia Gravis', chinese: '重症肌無力', abbr: 'MG' },
            { type: 'UD', code: 'M10.9', english: 'Gout', chinese: '痛風', abbr: 'Gout' },
            // Symptoms (SYM)
            { type: 'SYM', code: 'R17.0', english: 'Jaundice', chinese: '黃疸', abbr: 'Jaundice' },
            { type: 'SYM', code: 'R11.2', english: 'Nausea and vomiting', chinese: '噁心嘔吐', abbr: 'N/V' },
            { type: 'SYM', code: 'R10.3', english: 'Abdominal pain', chinese: '腹痛', abbr: 'Abd pain' },
            { type: 'SYM', code: 'R07.4', english: 'Chest pain', chinese: '胸痛', abbr: 'CP' },
            { type: 'SYM', code: 'R07.2', english: 'Precordial pain', chinese: '心前區疼痛', abbr: 'PC pain' },
            { type: 'SYM', code: 'R51', english: 'Headache', chinese: '頭痛', abbr: 'HA' },
            { type: 'SYM', code: 'R40.2', english: 'Coma', chinese: '昏迷', abbr: 'Coma' },
            { type: 'SYM', code: 'R06.02', english: 'Shortness of breath (Dyspnea)', chinese: '呼吸困難', abbr: 'SOB' },
            { type: 'SYM', code: 'R06.00', english: 'Tachypnea', chinese: '呼吸急促', abbr: 'Tachypnea' },
            { type: 'SYM', code: 'R50.9', english: 'Fever', chinese: '發燒', abbr: 'Fever' },
            { type: 'SYM', code: 'R68.8', english: 'Chills', chinese: '寒顫', abbr: 'Chills' },
            { type: 'SYM', code: 'R21.0', english: 'Skin pruritus', chinese: '皮膚搔癢', abbr: 'Pruritus' },
            { type: 'SYM', code: 'R31.0', english: 'Tea color urine', chinese: '茶色尿', abbr: 'Tea urine' },
            { type: 'SYM', code: 'R31.9', english: 'Hematuria (Blood in urine)', chinese: '血尿', abbr: 'Hematuria' },
            { type: 'SYM', code: 'R30.0', english: 'Dysuria (Painful urination)', chinese: '排尿困難', abbr: 'Dysuria' },
            { type: 'SYM', code: 'R33.9', english: 'Urinary retention', chinese: '尿滯留', abbr: 'Retention' },
            { type: 'SYM', code: 'K92.1', english: 'Melena (Black stool)', chinese: '黑便', abbr: 'Melena' },
            { type: 'SYM', code: 'K92.2', english: 'Hematochezia (Fresh blood in stool)', chinese: '血便', abbr: 'Hema' },
            { type: 'SYM', code: 'R19.7', english: 'Diarrhea', chinese: '腹瀉', abbr: 'Diarrhea' },
            { type: 'SYM', code: 'R58.0', english: 'Weight loss, abnormal', chinese: '體重減輕', abbr: 'WL' },
            { type: 'SYM', code: 'R53.81', english: 'Fatigue (Exhaustion)', chinese: '疲倦', abbr: 'Fatigue' },
            { type: 'SYM', code: 'R53.1', english: 'Generalized weakness', chinese: '全身無力', abbr: 'Weakness' },
            { type: 'SYM', code: 'R26.2', english: 'Gait disturbance', chinese: '步態不穩', abbr: 'Gait' },
            { type: 'SYM', code: 'R42', english: 'Dizziness (Vertigo)', chinese: '頭暈', abbr: 'Dizzy' },
            { type: 'SYM', code: 'R55', english: 'Syncope (Fainting)', chinese: '昏厥', abbr: 'Syncope' },
            { type: 'SYM', code: 'R05', english: 'Cough', chinese: '咳嗽', abbr: 'Cough' },
            { type: 'SYM', code: 'R60.9', english: 'Edema (Swelling)', chinese: '水腫', abbr: 'Edema' },
            { type: 'SYM', code: 'M25.50', english: 'Joint pain (Arthralgia)', chinese: '關節痛', abbr: 'Joint pain' },
            // OB/GYN Symptoms
            { type: 'SYM', code: 'N93.9', english: 'Abnormal uterine bleeding', chinese: '異常子宮出血', abbr: 'AUB' },
            { type: 'SYM', code: 'N94.6', english: 'Dysmenorrhea', chinese: '經痛', abbr: 'Dysmenorrhea' },
            { type: 'SYM', code: 'R10.2', english: 'Pelvic pain', chinese: '骨盆腔疼痛', abbr: 'Pelvic Pain' },
            { type: 'SYM', code: 'N89.8', english: 'Vaginal discharge', chinese: '陰道分泌物', abbr: 'Discharge' },
            { type: 'SYM', code: 'O20.9', english: 'Threatened abortion', chinese: '先兆流產', abbr: 'TA' },
            { type: 'SYM', code: 'N95.9', english: 'Menopausal symptoms', chinese: '更年期症狀', abbr: 'Menopause' },
            { type: 'SYM', code: 'O44.1', english: 'Placenta previa', chinese: 'Placenta previa bleeding', abbr: 'PP' },
        ];
        
        const denialSymptomGroups = {
            'R17.0': [ // Jaundice (黃疸)
                { key: 'pain', english: 'severe abdominal pain', chinese: '嚴重腹痛', checked: true },
                { key: 'fever', english: 'high fever with rigor', chinese: '高燒伴隨寒顫', checked: false },
                { key: 'stool', english: 'pale stool or clay color stool', chinese: '灰白便/陶土色便', checked: true },
                { key: 'bleeding', english: 'skin ecchymosis or coagulopathy', chinese: '皮膚瘀斑/凝血障礙', checked: true },
                { key: 'vomit', english: 'nausea or bilious vomiting', chinese: '噁心或膽汁性嘔吐', checked: false },
                { key: 'weight', english: 'marked body weight loss', chinese: '顯著體重減輕', checked: false },
                { key: 'loc', english: 'altered mental status (HE)', chinese: '意識改變 (HE)', checked: false },
                { key: 'ascites', english: 'abdominal distension (ascites)', chinese: '腹脹 (腹水)', checked: false },
                { key: 'alcohol', english: 'history of heavy alcohol abuse', chinese: '大量飲酒史', checked: false },
                { key: 'pruritus', english: 'severe generalized pruritus', chinese: '嚴重全身搔癢', checked: false },
            ],
            'R10.3': [ // Abdominal pain (腹痛)
                { key: 'rebound', english: 'rebound tenderness or guarding', chinese: '反彈痛/腹部僵硬', checked: false },
                { key: 'fever', english: 'fever, chills, or tachycardia', chinese: '發燒、寒顫或心搏過速', checked: true },
                { key: 'vomit', english: 'projectile or feculent vomiting', chinese: '噴射性嘔吐或糞便樣嘔吐', checked: true },
                { key: 'bleeding', english: 'frank hematochezia or melena', chinese: '鮮血便或黑便', checked: true },
                { key: 'obstipation', english: 'obstipation (no flatus)', chinese: '排氣或排便停止', checked: false },
                { key: 'migratory', english: 'pain migrating to the back or groin', chinese: '疼痛向背部或腹股溝轉移', checked: false },
                { key: 'chest', english: 'associated chest pain or SOB', chinese: '伴隨胸痛或呼吸困難', checked: false },
                { key: 'jaundice', english: 'jaundice or tea color urine', chinese: '黃疸或茶色尿', checked: false },
                { key: 'dysuria', english: 'dysuria or urinary frequency', chinese: '排尿困難或頻尿', checked: false },
                { key: 'period', english: 'missed menstrual period or vaginal bleeding', chinese: '月經遲到或陰道出血', checked: false },
            ],
            'R07.4': [ // Chest pain (胸痛)
                { key: 'radiation', english: 'pain radiating to jaw, neck, or arm', chinese: '疼痛輻射至下巴、頸部或手臂', checked: false },
                { key: 'sweating', english: 'diaphoresis (cold sweating)', chinese: '冒冷汗', checked: true },
                { key: 'sob', english: 'shortness of breath or dyspnea', chinese: '呼吸困難', checked: true },
                { key: 'palpitation', english: 'palpitation or syncope', chinese: '心悸或昏厥', checked: false },
                { key: 'pleuritic', english: 'pleuritic pain (worse with breathing)', chinese: '肋膜性疼痛 (呼吸時加劇)', checked: false },
                { key: 'cough', english: 'cough or hemoptysis', chinese: '咳嗽或咳血', checked: false },
                { key: 'exertion', english: 'pain related to exertion', chinese: '疼痛與活動相關', checked: false },
                { key: 'gi', english: 'heartburn, acid reflux, or dysphagia', chinese: '胃灼熱、胃酸逆流或吞嚥困難', checked: false },
                { key: 'tearing', english: 'tearing sensation migrating to the back', chinese: '撕裂感並轉移至背部', checked: false },
                { key: 'tenderness', english: 'localized chest wall tenderness', chinese: '局部胸壁壓痛', checked: false },
            ],
            'R51': [ // Headache (頭痛)
                { key: 'thunderclap', english: 'thunderclap onset (sudden, severe)', chinese: '雷擊樣頭痛 (突然劇痛)', checked: false },
                { key: 'fever', english: 'fever, neck stiffness, or photophobia', chinese: '發燒、頸部僵硬或畏光', checked: true },
                { key: 'neuro', english: 'focal neurologic deficits (weakness, numbness)', chinese: '局部神經學缺損 (無力、麻木)', checked: true },
                { key: 'vision', english: 'visual changes (blurring, double vision)', chinese: '視力改變 (模糊、複視)', checked: true },
                { key: 'trauma', english: 'recent head trauma', chinese: '近期頭部創傷', checked: false },
                { key: 'loc', english: 'change in consciousness or seizure', chinese: '意識改變或癲癇發作', checked: false },
                { key: 'positional', english: 'worse with coughing, sneezing, or position change', chinese: '咳嗽、打噴嚏或姿勢改變時加劇', checked: false },
                { key: 'jaw', english: 'jaw claudication or scalp tenderness', chinese: '下顎跛行或頭皮壓痛', checked: false },
                { key: 'vomiting', english: 'persistent nausea or vomiting', chinese: '持續性噁心或嘔吐', checked: false },
                { key: 'history', english: 'change from typical headache pattern', chinese: '與平時頭痛模式不同', checked: false },
            ],
             'R06.02': [ // Shortness of breath (Dyspnea)
                { key: 'cp', english: 'chest pain or pressure', chinese: '胸痛或胸悶', checked: true },
                { key: 'pnd', english: 'orthopnea or paroxysmal nocturnal dyspnea (PND)', chinese: '端坐呼吸或陣發性夜間呼吸困難', checked: false },
                { key: 'edema', english: 'lower limb edema or ascites', chinese: '下肢水腫或腹水', checked: false },
                { key: 'cough', english: 'cough, sputum production, or hemoptysis', chinese: '咳嗽、咳痰或咳血', checked: true },
                { key: 'wheezing', english: 'wheezing or history of asthma/COPD', chinese: '喘鳴或氣喘/COPD病史', checked: false },
                { key: 'fever', english: 'fever, chills, or pleuritic pain', chinese: '發燒、寒顫或肋膜性疼痛', checked: false },
                { key: 'dvt', english: 'unilateral leg swelling or pain (DVT signs)', chinese: '單側腿部腫痛 (DVT跡象)', checked: false },
                { key: 'anxiety', english: 'anxiety, perioral numbness, or tingling', chinese: '焦慮、口周麻木或刺痛感', checked: false },
                { key: 'weakness', english: 'generalized weakness or fatigue', chinese: '全身無力或疲倦', checked: false },
                { key: 'syncope', english: 'dizziness or syncope', chinese: '頭暈或昏厥', checked: false },
            ],
            'DEFAULT': [ // 當沒有特定主訴時的預設列表
                { key: 'fever', english: 'fever or chills', chinese: '發燒或寒顫', checked: true },
                { key: 'headache', english: 'headache or dizziness', chinese: '頭痛或頭暈', checked: true },
                { key: 'cp', english: 'chest pain or palpitation', chinese: '胸痛或心悸', checked: true },
                { key: 'sob', english: 'shortness of breath or cough', chinese: '呼吸困難或咳嗽', checked: true },
                { key: 'abd', english: 'abdominal pain', chinese: '腹痛', checked: true },
                { key: 'vomit', english: 'nausea or vomiting', chinese: '噁心或嘔吐', checked: true },
                { key: 'bowel', english: 'diarrhea or constipation', chinese: '腹瀉或便秘', checked: true },
                { key: 'urine', english: 'dysuria or urinary frequency', chinese: '排尿困難或頻尿', checked: true },
                { key: 'bleeding', english: 'easy bruising or bleeding tendency', chinese: '容易瘀青或出血傾向', checked: false },
                { key: 'weight', english: 'significant body weight change', chinese: '顯著體重變化', checked: false },
            ]
        };

        const NORMAL_RANGES = {
            'WBC': { min: 4.0, max: 11.0, unit: 'K/μL' },
            'RBC': { unit: 'million/uL', male: { min: 4.5, max: 5.9 }, female: { min: 3.9, max: 5.2 } },
            'Hb': { unit: 'g/dL', male: { min: 13.5, max: 17.5 }, female: { min: 12.0, max: 15.5 } },
            'Plt': { min: 150, max: 450, unit: 'K/μL' },
            'INR': { min: 0.8, max: 1.2, unit: '' },
            'Cr': { min: 0.5, max: 1.2, unit: 'mg/dL' },
            'Tbil': { min: 0.2, max: 1.2, unit: 'mg/dL' },
            'AST': { min: 8, max: 48, unit: 'U/L' },
            'ALT': { min: 7, max: 55, unit: 'U/L' },
            'Na': { min: 135, max: 145, unit: 'mEq/L' },
            'K': { min: 3.5, max: 5.0, unit: 'mEq/L' },
            'CRP': { min: 0.0, max: 5.0, unit: 'mg/L' },
            'Albumin': { min: 3.5, max: 5.5, unit: 'g/dL' },
        };

        // 應用程式的「狀態 (State)」
        let selectedUDs = [];
        let selectedSymptoms = [];
        let selectedCC = []; 
        let selectedIMP = [];
        
        const LOCAL_STORAGE_KEY = 'paHelperFormData_v1';

        // --- 自動暫存功能 (LocalStorage) ---
        function saveFormState() {
            const form = document.getElementById('note-form');
            const formData = new FormData(form);
            const formValues = Object.fromEntries(formData.entries());

            const deniedSymptomsState = {};
            document.querySelectorAll('.denied-sym-checkbox').forEach(cb => {
                deniedSymptomsState[cb.dataset.key] = cb.checked;
            });

            const stateToSave = {
                formValues,
                selectedUDs,
                selectedSymptoms,
                selectedCC,
                selectedIMP,
                deniedSymptoms: deniedSymptomsState,
                deniedSymptomsCC: selectedCC.length > 0 ? selectedCC[0].code : 'DEFAULT',
            };

            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(stateToSave));
            } catch (error) {
                console.error("無法儲存狀態:", error);
            }
        }

        function loadFormState() {
            try {
                const savedStateJSON = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (!savedStateJSON) return;

                const savedState = JSON.parse(savedStateJSON);

                // 恢復 Tag 狀態
                selectedUDs = savedState.selectedUDs || [];
                selectedSymptoms = savedState.selectedSymptoms || [];
                selectedCC = savedState.selectedCC || [];
                selectedIMP = savedState.selectedIMP || [];

                // 恢復表單欄位值
                for (const key in savedState.formValues) {
                    const element = document.getElementById(key);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = savedState.formValues[key] === 'on';
                        } else {
                            element.value = savedState.formValues[key];
                        }
                    }
                }
                
                // 觸發 UI 更新
                renderSelectedUDs();
                renderSelectedSymptoms();
                renderSelectedIMP();
                renderSelectedCC(); // 這會觸發 denied symptoms 的渲染
                
                // 恢復否認症狀的勾選狀態
                const currentCC = selectedCC.length > 0 ? selectedCC[0].code : 'DEFAULT';
                if (currentCC === savedState.deniedSymptomsCC && savedState.deniedSymptoms) {
                    for (const key in savedState.deniedSymptoms) {
                         const checkbox = document.querySelector(`.denied-sym-checkbox[data-key="${key}"]`);
                         if(checkbox) {
                             checkbox.checked = savedState.deniedSymptoms[key];
                         }
                    }
                }

                toggleObgynSection();
                toggleOpdSection();
                generateNote(); // 最後產生一次 Note

            } catch (error) {
                console.error("無法載入狀態:", error);
                localStorage.removeItem(LOCAL_STORAGE_KEY);
            }
        }
        
        function clearFormState() {
            if (confirm('您確定要清除所有已輸入的內容與暫存紀錄嗎？此操作無法復原。')) {
                localStorage.removeItem(LOCAL_STORAGE_KEY);
                
                selectedUDs = [];
                selectedSymptoms = [];
                selectedCC = [];
                selectedIMP = [];
                
                document.getElementById('note-form').reset();
                
                renderSelectedUDs();
                renderSelectedSymptoms();
                renderSelectedIMP();
                renderSelectedCC();
                
                toggleObgynSection();
                toggleOpdSection();
                generateNote();
                document.getElementById('lab-summary-output').innerHTML = '<span class="text-gray-500 text-xs">自動提取的關鍵結果將顯示在這裡...</span>';
            }
        }


        // --- Helper functions for search and tag rendering ---
        function renderSelectedTags(containerId, dataArray, removeFunction, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const isCC = type === 'CC';
            if (dataArray.length === 0) {
                container.textContent = '請搜索並選擇...';
                container.classList.add('text-gray-400', 'italic', 'text-sm');
                if (type !== 'CC') { // CC的generateNote在renderDeniedSymptoms中調用
                    generateNote();
                }
                return;
            }
            container.classList.remove('text-gray-400', 'italic', 'text-sm');
            dataArray.forEach(item => {
                const tag = document.createElement('span');
                let tagColor = isCC ? 'bg-red-500' : (type === 'UD' || type === 'IMP' ? 'bg-primary' : 'bg-secondary');
                tag.className = `inline-flex items-center text-xs font-medium ${tagColor} text-white rounded-full px-3 py-1 cursor-pointer`;
                tag.innerHTML = `${item.english} <svg class="w-3 h-3 ml-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`;
                tag.onclick = (e) => { e.stopPropagation(); removeFunction(item.code); };
                container.appendChild(tag);
            });
            if (type !== 'CC') {
                generateNote();
            }
        }

        function handleSearchInput(event, typeFilter, suggestionsDivId, addFunction) {
            const input = event.target.value.toLowerCase().trim();
            const suggestionsDiv = document.getElementById(suggestionsDivId);
            suggestionsDiv.innerHTML = '';

            if (input.length < 1) { 
                suggestionsDiv.classList.add('hidden');
                return;
            }
            
            const rankedResults = icd10Data
                .filter(item => item.type === typeFilter)
                .map(item => {
                    const en = item.english.toLowerCase();
                    const cn = item.chinese;
                    const code = item.code.toLowerCase();
                    const abbr = item.abbr ? item.abbr.toLowerCase() : '';
                    
                    let relevance = 99;
                    if (abbr.startsWith(input)) relevance = 0;
                    else if (en.startsWith(input) || cn.startsWith(input) || code.startsWith(input)) relevance = 1;
                    else if (en.includes(input) || cn.includes(input) || code.includes(input) || abbr.includes(input)) relevance = 2;
                    else return null;

                    return { ...item, relevance };
                })
                .filter(item => item !== null)
                .sort((a, b) => a.relevance - b.relevance);

            if (rankedResults.length > 0) {
                rankedResults.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'autocomplete-item p-2 cursor-pointer text-sm flex justify-between items-center';
                    itemElement.innerHTML = `<div><span class="font-medium">${item.english}</span> <span class="text-gray-500">(${item.chinese})</span> ${item.abbr ? `<span class="text-xs text-secondary ml-2">[${item.abbr}]</span>` : ''}</div><span class="text-xs text-gray-400">${item.code}</span>`;
                    itemElement.onclick = () => {
                        addFunction(item.code, item.english, item.chinese, item.abbr);
                        suggestionsDiv.classList.add('hidden');
                        event.target.value = '';
                    };
                    suggestionsDiv.appendChild(itemElement);
                });
                suggestionsDiv.classList.remove('hidden');
            } else { 
                suggestionsDiv.classList.add('hidden'); 
            }
        }
        
        // --- CC functions (Corrected Logic) ---
        function renderSelectedCC() {
            renderSelectedTags('selected-cc-tag', selectedCC, removeCC, 'CC');
            renderDeniedSymptoms(); 
        }

        function addCC(code, english, chinese, abbr) {
            selectedCC = [{ code, english: english.toLowerCase(), chinese, abbr }];
            renderSelectedCC();
        }

        function removeCC() {
            selectedCC = [];
            renderSelectedCC();
        }

        function handleCCSearch(event) { 
            handleSearchInput(event, 'SYM', 'cc-suggestions', addCC); 
        }
        
        // --- Other selection functions ---
        function renderSelectedUDs() { renderSelectedTags('selected-ud-tags', selectedUDs, removeUD, 'UD'); }
        function addUD(code, english, chinese, abbr) { if (!selectedUDs.some(s => s.code === code)) { selectedUDs.push({ code, english, chinese, abbr }); } renderSelectedUDs(); }
        function removeUD(code) { selectedUDs = selectedUDs.filter(s => s.code !== code); renderSelectedUDs(); }
        function handleUDSearch(event) { handleSearchInput(event, 'UD', 'ud-suggestions', addUD); }

        function renderSelectedIMP() { renderSelectedTags('selected-imp-tag', selectedIMP, removeIMP, 'IMP'); }
        function addIMP(code, english, chinese, abbr) { selectedIMP = [{ code, english, chinese, abbr }]; renderSelectedIMP(); }
        function removeIMP() { selectedIMP = []; renderSelectedIMP(); }
        function handleIMPSearch(event) { handleSearchInput(event, 'UD', 'imp-suggestions', addIMP); }

        function renderSelectedSymptoms() { renderSelectedTags('selected-symptoms-tags', selectedSymptoms, removeSymptom, 'SYM'); }
        function addSymptom(code, english, chinese, abbr) { if (!selectedSymptoms.some(s => s.code === code)) { selectedSymptoms.push({ code, english: english.toLowerCase(), chinese, abbr }); } renderSelectedSymptoms(); }
        function removeSymptom(code) { selectedSymptoms = selectedSymptoms.filter(s => s.code !== code); renderSelectedSymptoms(); }
        function handleSymptomSearch(event) { handleSearchInput(event, 'SYM', 'symptom-suggestions', addSymptom); }

        // --- Dynamic UI Logic ---
        function renderDeniedSymptoms() {
            const container = document.getElementById('denied-symptoms-container');
            container.innerHTML = '';
            
            const ccCode = selectedCC.length > 0 ? selectedCC[0].code : 'DEFAULT';
            const ccKey = Object.keys(denialSymptomGroups).find(key => key === ccCode) || 'DEFAULT';
            const suggestions = denialSymptomGroups[ccKey];

            if (!suggestions) return;

            suggestions.forEach(item => {
                const label = document.createElement('label');
                label.className = 'inline-flex items-center';
                const displayText = item.chinese ? `${item.english} (${item.chinese})` : item.english;
                label.innerHTML = `<input type="checkbox" data-key="${item.key}" ${item.checked ? 'checked' : ''} class="denied-sym-checkbox form-checkbox text-red-500 rounded"><span class="ml-2 text-gray-700" data-english-text="${item.english}">${displayText}</span>`;
                container.appendChild(label);
            });
            
            // BUG FIX: Ensure checkbox changes call both generateNote and saveFormState
            container.querySelectorAll('.denied-sym-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    generateNote();
                    saveFormState();
                });
            });
            generateNote(); // 確保在渲染否認症狀後立即更新Note
        }

        function toggleObgynSection() {
            const isFemale = document.getElementById('gender').value === 'female';
            document.getElementById('obgyn-section').classList.toggle('hidden', !isFemale);
            if (!isFemale) {
                document.getElementById('gravida').value = '';
                document.getElementById('para').value = '';
                document.getElementById('lmp').value = '';
            }
        }
        function toggleOpdSection() {
            const visitedOpd = document.getElementById('visited-opd').checked;
            document.getElementById('opd-course-section').classList.toggle('hidden', !visitedOpd);
        }
        function parseAndSummarizeLabData(rawText, gender) {
            const lines = rawText.split('\n');
            const results = {};
            const KEY_MAP = {
                'WBC': 'WBC', 'White Blood Cell': 'WBC',
                'RBC': 'RBC', 'Red Blood Cell': 'RBC',
                'Hemoglobin': 'Hb', 'Hemo': 'Hb',
                'Platelets': 'Plt', 'Plt': 'Plt',
                'INR': 'INR', 'P.T': 'INR',
                'Creatinine': 'Cr', 'Cr': 'Cr',
                'Total Bilirubin': 'Tbil', 'Tbil': 'Tbil',
                'AST': 'AST', 'GOT': 'AST',
                'ALT': 'ALT', 'GPT': 'ALT',
                'Na': 'Na', 'Sodium': 'Na',
                'K': 'K', 'Potassium': 'K',
                'Albumin': 'Albumin', 'Alb': 'Albumin',
                'CRP': 'CRP',
            };
            const valueRegex = /([\d\.]+)\s*(\S*)$/;
            lines.forEach(line => {
                if (!line.trim()) return;
                const upperLine = line.toUpperCase();
                for (const rawKey in KEY_MAP) {
                    if (upperLine.includes(rawKey.toUpperCase())) {
                        const standardKey = KEY_MAP[rawKey];
                        const match = line.match(valueRegex);
                        if (match) {
                            const value = parseFloat(match[1]);
                            if (!isNaN(value)) {
                                results[standardKey] = value;
                                return;
                            }
                        }
                    }
                }
            });

            const htmlParts = [], narrativeParts = [];
            const hematology = [], biochemistry = [], inflammatory = [];

            for (const key in results) {
                const value = results[key];
                const rangeData = NORMAL_RANGES[key];
                let range = rangeData, isAbnormal = false, status = 'Normal', colorClass = 'text-green-600';
                if (rangeData && rangeData[gender]) range = rangeData[gender];
                
                let min = range ? range.min : null;
                let max = range ? range.max : null;

                if (min !== null && max !== null) {
                    if (value < min) { isAbnormal = true; status = 'Low'; colorClass = 'text-red-600'; } 
                    else if (value > max) { isAbnormal = true; status = 'High'; colorClass = 'text-red-600'; }
                }
                
                if (isAbnormal) {
                    let part = status === 'High' ? `elevated ${key} (${value})` : `low ${key} (${value})`;
                    if (['WBC', 'RBC', 'Hb', 'Plt', 'INR'].includes(key)) hematology.push(part);
                    else if (['Tbil', 'Cr', 'AST', 'ALT', 'Na', 'K', 'Albumin'].includes(key)) biochemistry.push(part);
                    else if (['CRP'].includes(key)) inflammatory.push(part);
                }
                htmlParts.push(`<span class="inline-block px-3 py-1 mr-2 mb-1 rounded text-xs border ${isAbnormal ? 'bg-red-100 border-red-400' : 'bg-green-100 border-green-400'}"><span class="font-bold">${key}:</span> <span class="${colorClass} font-semibold">${value}</span> <span class="text-gray-500">(${status})</span></span>`);
            }
            if(hematology.length > 0) narrativeParts.push(`hematology results showing ${hematology.join(', ')}`);
            if(biochemistry.length > 0) narrativeParts.push(`biochemistry findings including ${biochemistry.join(', ')}`);
            if(inflammatory.length > 0) narrativeParts.push(`inflammatory markers showing ${inflammatory.join(', ')}`);

            const labNarrative = narrativeParts.join(', with ');
            const finalHtml = htmlParts.length > 0 ? htmlParts.join('') : '<span class="text-gray-400 text-xs">未偵測到有效檢驗數據。</span>';
            return { text: labNarrative, html: finalHtml };
        }

        // --- Core Note Generation Logic ---
        function generateNote() {
            // Helper for pronouns
            const gender = document.getElementById('gender').value;
            const pronoun = gender === 'female' ? 'she' : 'he';

            // 1. Demographics & History
            const age = document.getElementById('age').value;
            let firstLine = `The patient was a ${age ? age + '-year-old' : 'certain age'} ${gender}`;
            if (gender === 'female') {
                const gravida = document.getElementById('gravida').value;
                const para = document.getElementById('para').value;
                if (gravida && para) firstLine += ` (G${gravida}P${para})`;
            }
            firstLine += ' with underlying diseases of:\n';
            const udList = selectedUDs.length > 0 ? selectedUDs.map((ud, i) => `${i + 1}. ${ud.english}`).join('\n') : '1. N/A';
            const adl = document.getElementById('adl-status').value;
            const historyParagraph = `${firstLine}${udList}\nThis patient was ADL ${adl} before.`;
            
            // 2. HPI
            const cc = selectedCC.length > 0 ? selectedCC[0].english : 'the chief complaint';
            const durationVal = document.getElementById('cc-duration-value').value;
            const durationUnit = document.getElementById('cc-duration-unit').value;
            const durationText = durationVal ? ` for ${durationVal} ${durationUnit}` : '';
            
            const ccCharacter = document.getElementById('cc-character').value;
            const hpiNarrative = document.getElementById('hpi-narrative').value || `${ccCharacter} ${cc}`;

            const associatedSymptoms = selectedSymptoms.length > 0 ? ` accompanied by ${selectedSymptoms.map(s => s.english).join(', ')}` : '';
            
            const deniedSymptoms = Array.from(document.querySelectorAll('.denied-sym-checkbox:checked'))
                .map(cb => cb.nextElementSibling.getAttribute('data-english-text'));
            const deniedText = deniedSymptoms.length > 0 ? deniedSymptoms.join(', ') : 'the common symptoms';
            
            const hpiParagraph = `This time, ${pronoun} had ${hpiNarrative}${durationText}.${associatedSymptoms}. ${pronoun.charAt(0).toUpperCase() + pronoun.slice(1)} denied ${deniedText}.`;

            // 3. ER/OPD Course
            const visitedOpd = document.getElementById('visited-opd').checked;
            let courseParagraph = `Due to the above problems, the patient went to our ER for first aid.`;
            if (visitedOpd) {
                const labDate = document.getElementById('lab-date').value;
                const referralReason = document.getElementById('referral-reason').value;
                let opdParts = [];
                if (labDate) opdParts.push(`Abnormal biochemistry was noted on ${labDate} at clinic.`);
                if (referralReason) {
                    opdParts.push(`Due to the above situation, ${pronoun} visited our OPD and was referred to ER for ${referralReason}.`);
                } else {
                    opdParts.push(`Due to the above situation, ${pronoun} was referred to our ER for further management.`);
                }
                courseParagraph = opdParts.join(' ');
            }

            // ER Paragraph construction
            let erSentences = [];
            const t = document.getElementById('vs-t').value;
            const p = document.getElementById('vs-p').value;
            const r = document.getElementById('vs-r').value;
            const bp = document.getElementById('vs-bp').value;
            const spo2 = document.getElementById('vs-spo2').value;

            let vsParts = [];
            if (t) vsParts.push(`BT: ${t}°C`);
            if (p) vsParts.push(`PR: ${p} beats/min`);
            if (r) vsParts.push(`RR: ${r} cycles/min`);
            if (bp) vsParts.push(`BP: ${bp} mmHg`);
            if (spo2) vsParts.push(`SpO2: ${spo2}%`);
            if (vsParts.length > 0) {
                erSentences.push(`Vital signs showed ${vsParts.join(', ')}.`);
            }

            const mental = document.getElementById('mental-status').value;
            const gcsE = document.getElementById('gcs-e').value;
            const gcsV = document.getElementById('gcs-v').value;
            const gcsM = document.getElementById('gcs-m').value;
            if (gcsE || gcsV || gcsM) {
                erSentences.push(`The mental status was ${mental} with Glasgow coma scale of E${gcsE || '_'}V${gcsV || '_'}M${gcsM || '_'}.`);
            } else {
                erSentences.push(`The mental status was ${mental}.`);
            }

            const pe = document.getElementById('pe-findings').value;
            if (pe) erSentences.push(pe.endsWith('.') ? pe : pe + '.');

            const erManagement = document.getElementById('er-management').value;
            if (erManagement) erSentences.push(`${erManagement} for further survey.`);
            
            const rawLabInput = document.getElementById('lab-raw-input').value;
            const labSummary = parseAndSummarizeLabData(rawLabInput, gender);
            document.getElementById('lab-summary-output').innerHTML = labSummary.html;
            
            let labParts = [];
            if (labSummary.text) labParts.push(`Lab data revealed ${labSummary.text}`);
            
            const urineCulture = document.getElementById('urine-culture').value;
            if (urineCulture && urineCulture.toLowerCase() !== 'n/a') labParts.push(`urine culture: ${urineCulture}`);
            
            const stoolCulture = document.getElementById('stool-culture').value;
            if (stoolCulture && stoolCulture.toLowerCase() !== 'n/a') labParts.push(`stool culture: ${stoolCulture}`);
            
            if (labParts.length > 0) {
                erSentences.push(labParts.join(', ') + '.');
            }

            const imaging = document.getElementById('imaging-findings').value;
            if (imaging) erSentences.push(imaging.endsWith('.') ? imaging : imaging + '.');

            const erParagraph = erSentences.length > 0 ? `At the emergent department, ${erSentences.join(' ')}` : '';


            // 4. Impression & Plan
            const impression = selectedIMP.length > 0 ? selectedIMP[0].english : '';
            const plan = document.getElementById('admission-purpose').value;
            const impressionParagraph = (impression && plan) ? `Under the impression of ${impression}, the patient was admitted to our ward for ${plan}.` : '';

            document.getElementById('output-note').value = [historyParagraph, hpiParagraph, courseParagraph, erParagraph, impressionParagraph]
                .filter(p => p) // Remove empty paragraphs
                .join('\n\n');
        }

        // Event Listeners Setup
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('note-form');
            form.addEventListener('input', () => {
                generateNote();
                saveFormState(); // 在每次輸入後都儲存狀態
            });

            document.getElementById('gender').addEventListener('change', toggleObgynSection);
            document.getElementById('visited-opd').addEventListener('change', toggleOpdSection);

            const inputs = {
                'ud-search-input': handleUDSearch,
                'symptom-search-input': handleSymptomSearch,
                'cc-search-input': handleCCSearch,
                'imp-search-input': handleIMPSearch,
            };
            for (const id in inputs) {
                document.getElementById(id).addEventListener('input', inputs[id]);
            }
            
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.relative')) {
                   document.querySelectorAll('.autocomplete-list').forEach(div => div.classList.add('hidden'));
                }
            });

            document.getElementById('copy-button').addEventListener('click', () => {
                const textToCopy = document.getElementById('output-note').value;
                if (!textToCopy) return;
                navigator.clipboard.writeText(textToCopy).then(() => {
                    const msg = document.getElementById('copy-message');
                    msg.textContent = '已成功複製!';
                    msg.classList.remove('hidden');
                    setTimeout(() => msg.classList.add('hidden'), 2000);
                });
            });
            
            document.getElementById('clear-form-button').addEventListener('click', clearFormState);

            // Initial Render
            loadFormState(); // 頁面載入時，嘗試恢復上次的狀態
        });
    </script>
</body>
</html>


